@startuml
'https://plantuml.com/sequence-diagram

autonumber

actor Client
participant OrderController
participant PaymentController
participant UserService
participant OrderFacade
participant PaymentFacade
participant ProductService
participant PointService
participant OrderService
participant PaymentService

== 1. 주문 생성 ==
Client -> OrderController : POST /api/v1/orders
alt 인증 실패
    OrderController -> UserService : validate(X-USER-ID)
    UserService --> OrderController : 401 Unauthorized
    OrderController --> Client : 401 Unauthorized
else 인증 성공
    OrderController -> UserService : validate(X-USER-ID)
    UserService --> OrderController : OK
    OrderController -> OrderFacade : 주문 생성 요청(orderRequest)

    OrderFacade -> ProductService : 상품 유효성 검증 (재고 확인만)
    ProductService --> OrderFacade : 검증 OK

    OrderFacade -> OrderService : 주문 엔티티 생성 (상태: PENDING_PAYMENT)
    OrderService --> OrderFacade : 주문번호 반환

    OrderFacade --> OrderController : 주문 생성 완료
    OrderController --> Client : 200 OK + 주문번호
end

== 2. 결제 요청 ==
Client -> PaymentController : POST /api/v1/payments
alt 인증 실패
    PaymentController -> UserService : validate(X-USER-ID)
    UserService --> PaymentController : 401 Unauthorized
    PaymentController --> Client : 401 Unauthorized
else 인증 성공
    PaymentController -> UserService : validate(X-USER-ID)
    UserService --> PaymentController : OK
    PaymentController -> PaymentFacade : 결제 요청(orderNumber, paymentMethod, pointsToUse)

    PaymentFacade -> OrderService : 주문 상태 확인 (PENDING_PAYMENT인지)
    OrderService --> PaymentFacade : 상태 확인 OK
    
    alt 포인트 사용하는 경우
        PaymentFacade -> PointService : 포인트 잔액 확인 (차감하지 않음)
        PointService --> PaymentFacade : 잔액 확인 OK
    end
    
    PaymentFacade -> PaymentService : PG 결제 요청 생성
    PaymentService --> PaymentFacade : PG 결제 URL/token
    
    PaymentFacade --> PaymentController : 결제 정보 반환
    PaymentController --> Client : 200 OK + 결제 URL/token
end

== 3. 결제 완료 (콜백 처리) ==
note over Client : 사용자가 PG에서 결제 완료
activate PaymentService
PaymentService -> PaymentService : 결제 완료 처리
PaymentService -> ProductService : 재고 차감
ProductService --> PaymentService : 차감 완료

alt 포인트 사용한 경우
    PaymentService -> PointService : 포인트 차감
    PointService --> PaymentService : 차감 완료
end

PaymentService -> OrderService : 주문 상태 → PAYMENT_COMPLETED
OrderService --> PaymentService : 상태 변경 완료
deactivate PaymentService

@enduml